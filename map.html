<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë§µ ë§ˆìŠ¤í„° v2.2 (ì‹¤ì‹œê°„ ìœ„ì¹˜ì¶”ì )</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* 1. ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° í°íŠ¸ */
html, body { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; background: #eee; }
#map { width: 100%; height: 100%; z-index: 1; }

/* 2. ìƒë‹¨ ê²€ìƒ‰ë°” - ìœ ë¦¬ ì§ˆê° ë””ìì¸ */
.top-bar { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; display: flex; gap: 6px; }
.search-container { flex: 1; display: flex; background: rgba(255,255,255,0.9); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; backdrop-filter: blur(10px); }
#searchInput { flex: 1; border: none; padding: 12px; font-size: 15px; outline: none; background: transparent; }
.search-icon-btn { padding: 0 15px; border: none; background: transparent; color: #555; cursor: pointer; }
.layer-toggle-btn { width: 45px; height: 45px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; border: none; }

/* 3. ìš°ì¸¡ ë²„íŠ¼ ê·¸ë£¹ */
.side-btns { position: absolute; top: 65px; right: 10px; z-index: 900; display: flex; flex-direction: column; gap: 10px; }
.fab { width: 44px; height: 44px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 18px; color: #444; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
.fab.active { background: #007bff; color: white; border-color: #007bff; }

/* 4. í•˜ë‹¨ íŒ¨ë„ ë° íƒ­ */
.bottom-panel { position: absolute; bottom: 0; left: 0; right: 0; z-index: 1001; background: white; border-radius: 24px 24px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); }
.panel-header { display: flex; border-bottom: 1px solid #f0f0f0; }
.tab-btn { flex: 1; padding: 18px 0; text-align: center; font-size: 14px; font-weight: bold; color: #aaa; cursor: pointer; }
.tab-btn.active { color: #007bff; position: relative; }
.tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 30%; width: 40%; height: 3px; background: #007bff; border-radius: 3px; }
.panel-content { padding: 15px; min-height: 120px; max-height: 280px; overflow-y: auto; }

/* ìœ„ì¹˜ ì •ë³´ ì¹´ë“œ */
.info-card { background: rgba(33, 37, 41, 0.95); border-radius: 18px; padding: 18px; color: white; display: none; flex-direction: column; gap: 12px; backdrop-filter: blur(10px); }
.addr-val { font-size: 15px; line-height: 1.5; color: #f8f9fa; }
.coord-val { font-size: 12px; color: #adb5bd; font-family: monospace; }
.card-actions { display: flex; gap: 8px; }
.action-chip { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center; font-size: 13px; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.05); }
.action-chip:active { background: rgba(255,255,255,0.2); }

/* ì¸¡ì • ë„êµ¬ */
.measure-tools { display: none; flex-direction: column; gap: 15px; }
.tool-row { display: flex; gap: 8px; }
.tool-btn { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #eee; background: #f8f9fa; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 500; }
.tool-btn.active { background: #e7f1ff; border-color: #007bff; color: #007bff; }
.reset-btn { width: 100%; padding: 14px; background: #ff4757; color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); }

/* ê¸°íƒ€ UI */
.layer-menu { position: absolute; top: 60px; left: 10px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: none; overflow: hidden; z-index: 1100; border: 1px solid #eee; }
.layer-opt { padding: 15px 25px; font-size: 14px; border-bottom: 1px solid #f8f9fa; cursor: pointer; }
.layer-opt:last-child { border-bottom: none; }
#searchRes { position: absolute; top: 60px; left: 10px; right: 60px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); display: none; z-index: 1100; max-height: 250px; overflow-y: auto; }
.res-item { padding: 14px; border-bottom: 1px solid #f1f1f1; font-size: 14px; }

/* ë§µ ìœ„ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
.dist-label { background: white; border: 1px solid #007bff; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; color: #007bff; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.area-label { background: rgba(0, 123, 255, 0.9); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; border: 1.5px solid white; pointer-events: none; text-align: center; }
</style>
</head>
<body>

<div id="map"></div>

<div class="top-bar">
    <div class="search-container">
        <input id="searchInput" type="text" placeholder="ì¥ì†Œ, ê±´ë¬¼, ì£¼ì†Œ ê²€ìƒ‰" onkeydown="if(event.key==='Enter') doSearch()">
        <button class="search-icon-btn" onclick="doSearch()"><i class="fas fa-search"></i></button>
    </div>
    <button class="layer-toggle-btn" onclick="toggleLayerMenu()"><i class="fas fa-layer-group"></i></button>
</div>

<div id="searchRes"></div>
<div class="layer-menu" id="layerMenu">
    <div class="layer-opt" onclick="setBaseLayer('vworld_base')">ğŸ—ºï¸ ë¸Œì´ì›”ë“œ ì¼ë°˜</div>
    <div class="layer-opt" onclick="setBaseLayer('vworld_sat')">ğŸ›°ï¸ ë¸Œì´ì›”ë“œ ìœ„ì„±</div>
    <div class="layer-opt" onclick="setBaseLayer('google')">ğŸŒ êµ¬ê¸€ ì§€ë„</div>
</div>

<div class="side-btns">
    <div class="fab" id="gpsBtn" onclick="toggleGPS()"><i class="fas fa-crosshairs"></i></div>
    <div class="fab" id="rvBtn" onclick="toggleRoadView()"><i class="fas fa-street-view"></i></div>
    <div class="fab" onclick="window.location.reload()"><i class="fas fa-sync-alt"></i></div>
</div>

<div class="bottom-panel">
    <div class="panel-header">
        <div class="tab-btn active" id="tabLoc" onclick="switchTab('loc')">ë‚´ ìœ„ì¹˜ ì •ë³´</div>
        <div class="tab-btn" id="tabMeas" onclick="switchTab('meas')">ê±°ë¦¬/ë©´ì  ì¸¡ì •</div>
    </div>
    
    <div class="panel-content">
        <div id="locSection">
            <div id="locPlaceholder" style="text-align:center; font-size:14px; color:#888; padding: 20px 0;">ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ GPSë¥¼ ì¼œë©´<br>ì£¼ì†Œ ì •ë³´ê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
            <div id="locCard" class="info-card">
                <div id="addrText" class="addr-val">ì£¼ì†Œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                <div id="coordText" class="coord-val">Lat: - , Lng: -</div>
                <div class="card-actions">
                    <div class="action-chip" onclick="copyLoc()"><i class="far fa-copy"></i> ë³µì‚¬</div>
                    <div class="action-chip" onclick="shareLoc()"><i class="fas fa-share-alt"></i> ê³µìœ </div>
                    <div class="action-chip" onclick="saveLoc()"><i class="far fa-bookmark"></i> ì €ì¥</div>
                </div>
            </div>
        </div>

        <div id="measSection" class="measure-tools">
            <div class="tool-row">
                <div class="tool-btn active" id="m_line" onclick="setMode('line')">ğŸ“ ê±°ë¦¬</div>
                <div class="tool-btn" id="m_poly" onclick="setMode('polygon')">ğŸ“ ë©´ì </div>
                <div class="tool-btn" id="m_circle" onclick="setMode('circle')">â­• ë°˜ê²½ 500m</div>
            </div>
            <div class="tool-row">
                <button class="reset-btn" onclick="resetAll()">ì¸¡ì • ë°ì´í„° ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/** [1] ì§€ë„ ë° ë ˆì´ì–´ ì„¤ì • **/
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.5665, 126.9780], 16);
const layers = {
    vworld_base: L.tileLayer('https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png'),
    vworld_sat: L.layerGroup([
        L.tileLayer('https://xdworld.vworld.kr/2d/Satellite/service/{z}/{x}/{y}.jpeg'),
        L.tileLayer('https://xdworld.vworld.kr/2d/Hybrid/service/{z}/{x}/{y}.png')
    ]),
    google: L.tileLayer('https://mt0.google.com/vt/lyrs=m&hl=ko&x={x}&y={y}&z={z}')
};
layers.vworld_base.addTo(map);

function setBaseLayer(key) {
    Object.values(layers).forEach(l => map.removeLayer(l));
    layers[key].addTo(map);
    document.getElementById('layerMenu').style.display = 'none';
}
function toggleLayerMenu() {
    const m = document.getElementById('layerMenu');
    m.style.display = m.style.display === 'block' ? 'none' : 'block';
}

/** [2] ì‹¤ì‹œê°„ GPS ì¶”ì  ë¡œì§ (ìˆ˜ì •ë¨) **/
let myMarker = null;
let watchId = null;

function toggleGPS() {
    const btn = document.getElementById('gpsBtn');
    
    if (watchId !== null) {
        // ì¤‘ì§€ ëª¨ë“œ
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        btn.classList.remove('active');
        if (myMarker) map.removeLayer(myMarker);
        myMarker = null;
        return;
    }

    // ì‹œì‘ ëª¨ë“œ (watchPosition ì‚¬ìš©ìœ¼ë¡œ ì‹¤ì‹œê°„ ê°±ì‹ )
    btn.classList.add('active');
    watchId = navigator.geolocation.watchPosition(
        (pos) => {
            const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
            
            // 1. ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            if (!myMarker) {
                myMarker = L.circleMarker(latlng, {
                    radius: 9, color: 'white', weight: 3, fillColor: '#007bff', fillOpacity: 1
                }).addTo(map);
                map.setView(latlng, 17); // ì²˜ìŒ ì¡ì•˜ì„ ë•Œë§Œ ì´ë™
            } else {
                myMarker.setLatLng(latlng);
            }

            // 2. ì‹¤ì‹œê°„ ì£¼ì†Œ ë° ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
            updateInfo(latlng);
            switchTab('loc');
        },
        (err) => {
            alert("ì‹¤ì‹œê°„ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPS ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
            btn.classList.remove('active');
            watchId = null;
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    );
}

/** [3] ì£¼ì†Œ ë³€í™˜ ë° ì •ë³´ì°½ ì—…ë°ì´íŠ¸ **/
async function updateInfo(latlng) {
    document.getElementById('locPlaceholder').style.display = 'none';
    const card = document.getElementById('locCard');
    card.style.display = 'flex';
    document.getElementById('addrText').innerText = "í˜„ìœ„ì¹˜ ì£¼ì†Œ í™•ì¸ ì¤‘...";
    document.getElementById('coordText').innerText = `Lat: ${latlng.lat.toFixed(6)} Â· Lng: ${latlng.lng.toFixed(6)}`;

    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`, {
            headers: { 'Accept-Language': 'ko' }
        });
        const d = await res.json();
        document.getElementById('addrText').innerText = d.display_name || "ì£¼ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    } catch(e) { 
        document.getElementById('addrText').innerText = "ë„¤íŠ¸ì›Œí¬ ì‹ í˜¸ê°€ ì•½í•´ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."; 
    }
}

/** [4] ì¸¡ì • ë° ì¸í„°í˜ì´ìŠ¤ ì œì–´ **/
let currentMode = 'line';
let points = [];
let mapObjs = [];
let isRV = false;

function switchTab(type) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('locSection').style.display = 'none';
    document.getElementById('measSection').style.display = 'none';
    if(type === 'loc') {
        document.getElementById('tabLoc').classList.add('active');
        document.getElementById('locSection').style.display = 'block';
    } else {
        document.getElementById('tabMeas').classList.add('active');
        document.getElementById('measSection').style.display = 'flex';
        setMode(currentMode);
    }
}

function setMode(m) {
    currentMode = m;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('m_' + (m==='polygon'?'poly':m==='circle'?'circle':'line')).classList.add('active');
    resetCurrent();
}

map.on('click', e => {
    if(isRV) { window.open(`https://map.kakao.com/link/roadview/${e.latlng.lat},${e.latlng.lng}`); return; }
    
    updateInfo(e.latlng); // í´ë¦­í•œ ì§€ì  ì£¼ì†Œ ë³´ê¸°
    
    if(currentMode !== 'circle') {
        points.push(e.latlng);
        redraw();
    } else {
        drawCircle(e.latlng);
    }
});

function redraw() {
    mapObjs.forEach(o => map.removeLayer(o)); mapObjs = [];
    points.forEach(p => mapObjs.push(L.circleMarker(p, {radius:5, color:'#ff4757', fillColor:'#fff', fillOpacity:1, weight:2}).addTo(map)));
    
    if(currentMode === 'line' && points.length > 1) {
        const poly = L.polyline(points, {color:'#007bff', weight:3, dashArray: '5, 5'}).addTo(map);
        mapObjs.push(poly);
        const dist = points.reduce((acc,cur,idx,arr)=> idx>0?acc+map.distance(arr[idx-1],cur):0, 0);
        mapObjs.push(L.marker(points[points.length-1], {icon: L.divIcon({className:'dist-label', html:fmtD(dist)})}).addTo(map));
    } else if(currentMode === 'polygon' && points.length >= 3) {
        const poly = L.polygon(points, {color:'#007bff', fillColor:'#007bff', fillOpacity:0.1, weight:2}).addTo(map);
        mapObjs.push(poly);
        const area = computeArea(points);
        const html = `${Math.round(area).toLocaleString()}ã¡<br>(${(area/3.3058).toFixed(1)}í‰)`;
        mapObjs.push(L.marker(poly.getBounds().getCenter(), {icon: L.divIcon({className:'area-label', html:html, iconSize:[100, 40]})}).addTo(map));
    }
}

function drawCircle(center) {
    resetCurrent();
    const c = L.circle(center, {radius:500, color:'#007bff', weight:2, fillOpacity:0.1}).addTo(map);
    mapObjs.push(c);
    mapObjs.push(L.marker(center, {icon: L.divIcon({className:'dist-label', html:'ë°˜ê²½ 500m'})}).addTo(map));
}

async function doSearch() {
    const q = document.getElementById('searchInput').value;
    if(!q) return;
    const resDiv = document.getElementById('searchRes');
    resDiv.style.display = 'block';
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await r.json();
    resDiv.innerHTML = '';
    data.forEach(d => {
        const item = document.createElement('div');
        item.className = 'res-item';
        item.innerText = d.display_name;
        item.onclick = () => {
            const ll = L.latLng(d.lat, d.lon);
            map.setView(ll, 16);
            updateInfo(ll);
            resDiv.style.display = 'none';
        };
        resDiv.appendChild(item);
    });
}

function toggleRoadView() { isRV = !isRV; document.getElementById('rvBtn').classList.toggle('active', isRV); }
function resetCurrent() { points = []; mapObjs.forEach(o => map.removeLayer(o)); mapObjs = []; }
function resetAll() { resetCurrent(); }
function fmtD(d) { return d>=1000 ? (d/1000).toFixed(2)+'km' : Math.round(d)+'m'; }
function computeArea(pts) { 
    const R=6378137; let a=0; 
    for(let i=0;i<pts.length;i++){ 
        let p1=pts[i], p2=pts[(i+1)%pts.length]; 
        let x1=p1.lng*(Math.PI/180)*R*Math.cos(p1.lat*Math.PI/180), y1=p1.lat*(Math.PI/180)*R; 
        let x2=p2.lng*(Math.PI/180)*R*Math.cos(p2.lat*Math.PI/180), y2=p2.lat*(Math.PI/180)*R; 
        a += x1*y2 - x2*y1; 
    } return Math.abs(a/2); 
}
function copyLoc() { navigator.clipboard.writeText(document.getElementById('addrText').innerText); alert("ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }
function shareLoc() { if(navigator.share) navigator.share({title:'í˜„ìœ„ì¹˜ ê³µìœ ', text:document.getElementById('addrText').innerText}); }
function saveLoc() { alert("ì¥ì†Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); }
</script>
</body>
</html>

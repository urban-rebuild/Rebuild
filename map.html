<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë§µ ë§ˆìŠ¤í„°(ê±°ë¦¬ì¸¡ì •)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* 1. ê¸°ë³¸ ì„¤ì • (í°íŠ¸ ë° ë¦¬ì…‹) */
html, body { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', -apple-system, sans-serif; overflow: hidden; background: #f5f5f5; }
#map { width: 100%; height: 100%; z-index: 1; }

/* 2. ìƒë‹¨ ê²€ìƒ‰ë°” (í”Œë¡œíŒ… ìŠ¤íƒ€ì¼) */
.top-bar {
  position: absolute; top: 12px; left: 12px; right: 150px;
  z-index: 1000; pointer-events: none; /* ë¹ˆ ê³µê°„ í´ë¦­ í†µê³¼ */
  display: flex; justify-content: space-between; align-items: flex-start;
}
.search-box {
  pointer-events: auto;
  display: flex; width: 100%; max-width: 200px;
  background: white; border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
#searchInput { flex: 1; border: none; padding: 12px 16px; font-size: 16px; outline: none; border-radius: 8px 0 0 8px; }
#searchBtn { background: #2c3e50; color: white; border: none; padding: 0 16px; border-radius: 0 8px 8px 0; font-size: 18px; cursor: pointer; }

/* ìƒë‹¨ ìš°ì¸¡ ë²„íŠ¼ ê·¸ë£¹ */
.top-right-group {
  pointer-events: auto; display: flex; gap: 8px; margin-left: 10px;
}

/* 3. ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì¹´ë“œí˜•) */
.btn-card {
  width: 44px; height: 44px;
  background: white; border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; color: #555; cursor: pointer;
  border: 1px solid rgba(0,0,0,0.05);
  transition: all 0.1s ease-in-out;
}
.btn-card:active { transform: scale(0.95); background: #f8f9fa; }
.btn-card.active { background: #3498db; color: white; border-color: #3498db; }

/* 4. ìš°ì¸¡ í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼ (FAB) */
.right-fab-group {
  position: absolute; top: 80px; right: 12px; z-index: 900;
  display: flex; flex-direction: column; gap: 10px;
}
.fab-label { font-size: 10px; color: #666; text-align: center; margin-top: -3px; display:none;} 

/* 5. ìš°ì¸¡ í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ ê·¸ë£¹ (ì¤Œ, GPS) */
.nav-group {
  position: absolute; bottom: 100px; right: 12px; z-index: 900;
  display: flex; flex-direction: column; gap: 8px;
}
.zoom-group { display: flex; flex-direction: column; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); overflow: hidden; }
.zoom-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: #555; }
.zoom-btn:first-child { border-bottom: 1px solid #eee; }
.zoom-btn:active { background: #f0f0f0; }

/* 6. í•˜ë‹¨ ì‘ì—… ë„êµ¬ (Dock ìŠ¤íƒ€ì¼) */
.bottom-dock {
  position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
  z-index: 1000; width: 92%; max-width: 500px;
  background: white; border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  padding: 6px; display: flex; flex-direction: column; gap: 5px;
}
.dock-tabs { display: flex; justify-content: space-between; background: #f8f9fa; border-radius: 10px; padding: 4px; }
.dock-tab { 
  flex: 1; text-align: center; padding: 10px 0; 
  font-size: 13px; font-weight: 600; color: #7f8c8d; 
  border-radius: 8px; cursor: pointer; transition: all 0.2s; 
}
.dock-tab.active { background: white; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

/* í•˜ë‹¨ ì •ë³´ì°½ & ì»¨íŠ¸ë¡¤ */
.dock-content { padding: 0 5px; }
.info-text { font-size: 13px; color: #555; padding: 5px 0; text-align: center; }
.action-row { display: flex; gap: 8px; margin-top: 5px; }
.action-btn { flex: 1; padding: 8px 0; border-radius: 6px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; }
.btn-undo { background: #95a5a6; color: white; }
.btn-reset { background: #e74c3c; color: white; }

/* ë°˜ê²½ ì»¨íŠ¸ë¡¤ (Dock ìœ„ì— ëœ¸) */
#radiusControls { display: none; justify-content: center; gap: 5px; padding-bottom: 5px; }
.radius-chip { padding: 6px 12px; border-radius: 20px; border: 1px solid #ddd; background: white; font-size: 12px; color: #555; cursor: pointer; }
.radius-chip.selected { background: #3498db; color: white; border-color: #3498db; }

/* ë ˆì´ì–´ ë©”ë‰´ */
.layer-dropdown {
  position: absolute; top: 60px; right: 12px; z-index: 1100;
  background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  overflow: hidden; display: none; width: 140px;
}
.layer-item { padding: 12px; font-size: 14px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
.layer-item.active { background: #f0f8ff; color: #3498db; font-weight: bold; }

/* ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ */
#results { position: absolute; top: 60px; left: 12px; right: 12px; max-width: 360px; z-index: 1100; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: none; }
.result-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }

/* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
.dist-label { background: rgba(255,255,255,0.95); border: 1px solid #333; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; white-space: nowrap; pointer-events: none; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.area-label { background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px; text-align: center; border: 1px solid white; pointer-events: none; }

/* íŒì—… ìŠ¤íƒ€ì¼ */
.popup-btn { display: block; width: 100%; padding: 10px 0; margin-top: 5px; background: #f1c40f; color: #333; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

/* ë„ì›€ë§ ëª¨ë‹¬ */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
.modal-box { background: white; width: 85%; max-width: 350px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
.modal-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 13px; color: #555; }
.modal-icon { width: 30px; text-align: center; font-size: 16px; margin-right: 10px; }
</style>
</head>
<body>

<div class="top-bar">
  <div class="search-box">
    <input id="searchInput" type="text" placeholder="ì¥ì†Œ ê²€ìƒ‰" onkeydown="if(event.key==='Enter') doSearch()">
    <button id="searchBtn" onclick="doSearch()"><i class="fas fa-search"></i></button>
  </div>
  <div class="top-right-group">
    <div class="btn-card" onclick="toggleLayerMenu()"><i class="fas fa-layer-group"></i></div>
    <div class="btn-card" onclick="toggleHelp()" style="color:#3498db"><i class="fas fa-question"></i></div>
  </div>
</div>
<div id="results"></div>

<div class="layer-dropdown" id="layerMenu">
  <div class="layer-item active" onclick="setBaseLayer('vworld_base', this)">ë¸Œì´ì›”ë“œ (ì¼ë°˜)</div>
  <div class="layer-item" onclick="setBaseLayer('vworld_sat', this)">ë¸Œì´ì›”ë“œ (ìœ„ì„±)</div>
  <div class="layer-item" onclick="setBaseLayer('google', this)">êµ¬ê¸€ ì§€ë„</div>
</div>

<div class="right-fab-group">
  <div class="btn-card roadview-btn" id="btnRoadView" onclick="toggleRoadViewMode()"><i class="fas fa-street-view"></i></div>
  <div class="btn-card route-btn" id="btnRoute" onclick="toggleRouteMode()"><i class="fas fa-route"></i></div>
</div>

<div class="nav-group">
  <div class="btn-card compass-btn" id="btnCompass" onclick="toggleCompass()"><i class="far fa-compass"></i></div>
  <div class="btn-card gps-btn" id="btnGPS" onclick="toggleLocationTracking()"><i class="fas fa-crosshairs"></i></div>
  <div class="zoom-group">
    <div class="zoom-btn" onclick="map.zoomIn()"><i class="fas fa-plus"></i></div>
    <div class="zoom-btn" onclick="map.zoomOut()"><i class="fas fa-minus"></i></div>
  </div>
</div>

<div id="map"></div>

<div class="bottom-dock">
  <div id="radiusControls">
    <div class="radius-chip" onclick="toggleRadius(500, this)">500m</div>
    <div class="radius-chip" onclick="toggleRadius(1000, this)">1km</div>
    <div class="radius-chip" onclick="toggleRadius(3000, this)">3km</div>
  </div>

  <div class="dock-tabs">
    <div class="dock-tab active" onclick="setMode('line')" id="btnLine">ğŸ“ ê±°ë¦¬</div>
    <div class="dock-tab" onclick="setMode('polygon')" id="btnPoly">ğŸ“ ë©´ì </div>
    <div class="dock-tab" onclick="setMode('circle')" id="btnCircle">â­• ë°˜ê²½</div>
  </div>
  
  <div class="dock-content">
    <div id="infoText" class="info-text">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì¸¡ì •ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
    <div class="action-row">
      <button id="undoBtn" class="action-btn btn-undo" onclick="undoLastPoint()" style="display:none">ì‹¤í–‰ ì·¨ì†Œ</button>
      <button class="action-btn btn-reset" onclick="resetAll()">ì´ˆê¸°í™”</button>
    </div>
  </div>
</div>

<div id="helpModal" class="modal-overlay" onclick="if(event.target===this) toggleHelp()">
  <div class="modal-box">
    <div class="modal-title">ğŸ“– ì•± ì‚¬ìš© ê°€ì´ë“œ</div>
    <div class="modal-row"><i class="fas fa-layer-group modal-icon"></i> ì§€ë„ ë³€ê²½ (ì¼ë°˜/ìœ„ì„±/êµ¬ê¸€)</div>
    <div class="modal-row"><i class="fas fa-street-view modal-icon" style="color:#28a745"></i> ë¡œë“œë·° (í´ë¦­ í›„ ë„ë¡œ ì„ íƒ)</div>
    <div class="modal-row"><i class="fas fa-route modal-icon" style="color:#6610f2"></i> ê¸¸ì°¾ê¸° (ì¶œë°œ/ë„ì°© ì„ íƒ)</div>
    <div class="modal-row"><i class="fas fa-crosshairs modal-icon"></i> ë‚´ ìœ„ì¹˜ ì¶”ì  (GPS)</div>
    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
    <div class="modal-row"><span class="modal-icon">ğŸ“</span> ê±°ë¦¬ ì¸¡ì • (ë„ë³´ ì‹œê°„ í¬í•¨)</div>
    <div class="modal-row"><span class="modal-icon">ğŸ“</span> ë©´ì  ì¸¡ì • (í‰ìˆ˜ ìë™ ë³€í™˜)</div>
    <div class="modal-row"><span class="modal-icon">â­•</span> ë°˜ê²½ ê·¸ë¦¬ê¸° (ì—­ì„¸ê¶Œ ë¶„ì„ìš©)</div>
    <button class="action-btn btn-reset" style="width:100%; margin-top:10px; background:#3498db" onclick="toggleHelp()">ë‹«ê¸°</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 16);

// ë ˆì´ì–´
const baseLayers = {
  vworld_base: L.tileLayer('https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png', { maxZoom: 19 }),
  vworld_sat: L.layerGroup([
    L.tileLayer('https://xdworld.vworld.kr/2d/Satellite/service/{z}/{x}/{y}.jpeg', { maxZoom: 19 }),
    L.tileLayer('https://xdworld.vworld.kr/2d/Hybrid/service/{z}/{x}/{y}.png', { maxZoom: 19 })
  ]),
  google: L.tileLayer('https://mt0.google.com/vt/lyrs=m&hl=ko&x={x}&y={y}&z={z}', { maxZoom: 20 })
};
baseLayers.vworld_base.addTo(map);

function setBaseLayer(type, el) {
  Object.values(baseLayers).forEach(l => map.removeLayer(l));
  baseLayers[type].addTo(map);
  document.querySelectorAll('.layer-item').forEach(o => o.classList.remove('active'));
  el.classList.add('active'); 
  document.getElementById('layerMenu').style.display = 'none';
}
function toggleLayerMenu() { 
  const m = document.getElementById('layerMenu'); 
  m.style.display = m.style.display === 'block' ? 'none' : 'block'; 
}
function toggleHelp() {
  const m = document.getElementById('helpModal');
  m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; 
}
function openSmartWindow(url) {
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if (isMobile) window.open(url, '_blank');
  else window.open(url, "kp", "width=1200,height=800,resizable=yes");
}

// ìœ„ì¹˜ ì¶”ì 
let watchId = null; let myMarker = null;
function toggleLocationTracking() {
  const btn = document.getElementById('btnGPS');
  if(watchId) { navigator.geolocation.clearWatch(watchId); watchId=null; btn.classList.remove('active'); }
  else {
    if(!navigator.geolocation) return alert("GPS ë¯¸ì§€ì›");
    btn.classList.add('active');
    watchId = navigator.geolocation.watchPosition(p=>{
      const lat=p.coords.latitude, lng=p.coords.longitude;
      map.setView([lat,lng], map.getZoom());
      if(!myMarker) myMarker = L.circleMarker([lat,lng],{radius:8,color:'white',fillColor:'#007bff',fillOpacity:1}).addTo(map);
      else myMarker.setLatLng([lat,lng]);
    }, e=>{ alert("GPS ì‹¤íŒ¨"); btn.classList.remove('active'); watchId=null; }, {enableHighAccuracy:true});
  }
}

// ëª¨ë“œ ê´€ë¦¬
let mode = 'line'; let points = []; let mapObjs = []; let activeRadii = new Set();
const infoText = document.getElementById('infoText'); const undoBtn = document.getElementById('undoBtn');

// ë¡œë“œë·°
let isRoadViewMode = false; let roadViewMarker = null;
function toggleRoadViewMode() {
  isRoadViewMode = !isRoadViewMode; resetAllOtherModes('roadview');
  const btn = document.getElementById('btnRoadView');
  if(isRoadViewMode) { btn.classList.add('active'); map.getContainer().style.cursor = 'crosshair'; infoText.innerText="ë„ë¡œë¥¼ í´ë¦­í•˜ì„¸ìš” (ë¡œë“œë·°)"; }
  else { btn.classList.remove('active'); map.getContainer().style.cursor = ''; infoText.innerText="ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”"; if(roadViewMarker) map.removeLayer(roadViewMarker); setMode(mode); }
}

map.on('click', e => {
  if(isRoadViewMode) {
    const url = `https://map.kakao.com/link/roadview/${e.latlng.lat},${e.latlng.lng}`;
    const html = `<div style="text-align:center"><button class="popup-btn" onclick="openSmartWindow('${url}')">ë¡œë“œë·° ë³´ê¸°</button></div>`;
    if(roadViewMarker) map.removeLayer(roadViewMarker);
    roadViewMarker = L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
    return;
  }
  if(isRouteMode) { handleRouteClick(e); return; }
  
  // ì¸¡ì •
  if(mode==='line' || mode==='polygon') { points.push(e.latlng); redraw(); }
  else if(mode==='circle') { 
    if(activeRadii.size===0) return alert("ë°˜ê²½ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”");
    renderCircles(e.latlng);
  }
});

// ê¸¸ì°¾ê¸°
let isRouteMode = false; let routeStep=0; let rStart=null; let rEnd=null; let rObjs=[];
function toggleRouteMode() {
  isRouteMode = !isRouteMode; resetAllOtherModes('route');
  const btn = document.getElementById('btnRoute');
  if(isRouteMode) { btn.classList.add('active'); routeStep=1; infoText.innerText="ì¶œë°œì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”"; map.getContainer().style.cursor = 'context-menu'; rObjs.forEach(o=>map.removeLayer(o)); rObjs=[]; }
  else { btn.classList.remove('active'); map.getContainer().style.cursor = ''; infoText.innerText="ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”"; rObjs.forEach(o=>map.removeLayer(o)); rObjs=[]; setMode(mode); }
}
function handleRouteClick(e) {
  if(routeStep===1) {
    rStart=e.latlng; const m=L.marker(rStart).addTo(map); rObjs.push(m);
    routeStep=2; infoText.innerText="ë„ì°©ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”";
  } else if(routeStep===2) {
    rEnd=e.latlng; const m=L.marker(rEnd).addTo(map); rObjs.push(m);
    const line=L.polyline([rStart, rEnd], {color:'gray', dashArray:'5,5'}).addTo(map); rObjs.push(line);
    const url=`https://map.kakao.com/link/to/ë„ì°©,${rEnd.lat},${rEnd.lng}/from/ì¶œë°œ,${rStart.lat},${rStart.lng}`;
    L.popup().setLatLng(rEnd).setContent(`<div style="text-align:center"><button class="popup-btn" onclick="openSmartWindow('${url}')">ê¸¸ì°¾ê¸° ì—°ê²°</button></div>`).openOn(map);
    routeStep=1; infoText.innerText="ì¶œë°œì§€ ì¬ì„¤ì • ê°€ëŠ¥";
  }
}

// ì¸¡ì • í•¨ìˆ˜
function setMode(newMode) {
  mode = newMode; resetCurrentDrawing();
  document.querySelectorAll('.dock-tab').forEach(b => b.classList.remove('active'));
  if(mode==='line') { document.getElementById('btnLine').classList.add('active'); infoText.innerText="ì ì„ ì°ì–´ ê±°ë¦¬ë¥¼ ì¬ì„¸ìš”"; }
  if(mode==='polygon') { document.getElementById('btnPoly').classList.add('active'); infoText.innerText="ì ì„ ì°ì–´ ë©´ì ì„ ì¬ì„¸ìš”"; }
  if(mode==='circle') { 
    document.getElementById('btnCircle').classList.add('active'); 
    document.getElementById('radiusControls').style.display='flex'; 
    infoText.innerText="ë°˜ê²½ì„ ì„ íƒí•˜ê³  ì§€ë„ë¥¼ í´ë¦­í•˜ì„¸ìš”"; 
  } else {
    document.getElementById('radiusControls').style.display='none';
  }
  resetAllOtherModes('measure');
}
function undoLastPoint() { if(points.length>0) { points.pop(); redraw(); } }
function redraw() {
  mapObjs.forEach(o=>map.removeLayer(o)); mapObjs=[];
  if(points.length===0) { undoBtn.style.display='none'; return; }
  undoBtn.style.display='inline-block';
  points.forEach(p=> { const d=L.circleMarker(p,{radius:4,color:'red'}).addTo(map); mapObjs.push(d); });
  
  if(mode==='line' && points.length>1) {
    const l=L.polyline(points,{color:'blue'}).addTo(map); mapObjs.push(l);
    const dist=map.distance(points[points.length-2], points[points.length-1]);
    const total=points.reduce((acc,cur,idx,arr)=> idx>0?acc+map.distance(arr[idx-1],cur):0, 0);
    const label=L.marker(points[points.length-1], {icon: L.divIcon({className:'dist-label', html:`${fmt(total)}`, iconSize:[null,null]})}).addTo(map); mapObjs.push(label);
  }
  if(mode==='polygon') {
    if(points.length>=1) { const p=L.polygon(points,{color:'#f39c12'}).addTo(map); mapObjs.push(p); }
    if(points.length>=3) {
      const area=computeArea(points);
      const center=L.polygon(points).getBounds().getCenter();
      const html=`${Math.round(area).toLocaleString()}ã¡<br><span style="color:#ffd43b">${(area/3.3058).toFixed(1)}í‰</span>`;
      const label=L.marker(center, {icon: L.divIcon({className:'area-label', html:html, iconSize:[null,null]})}).addTo(map); mapObjs.push(label);
    }
  }
}
function renderCircles(center) {
  mapObjs.forEach(o=>map.removeLayer(o)); mapObjs=[];
  activeRadii.forEach(r=>{
    const c=L.circle(center, {radius:r, color:'#2ecc71', fill:false}).addTo(map); mapObjs.push(c);
    const label=L.marker([center.lat+(r/6378137)*(180/Math.PI), center.lng], {icon: L.divIcon({className:'dist-label', html:fmt(r), iconSize:[null,null]})}).addTo(map); mapObjs.push(label);
  });
}
function toggleRadius(m, btn) {
  if(activeRadii.has(m)) { activeRadii.delete(m); btn.classList.remove('selected'); }
  else { activeRadii.add(m); btn.classList.add('selected'); }
}
function resetCurrentDrawing() { points=[]; mapObjs.forEach(o=>map.removeLayer(o)); mapObjs=[]; undoBtn.style.display='none'; }
function resetAll() { 
  resetCurrentDrawing(); rObjs.forEach(o=>map.removeLayer(o)); rObjs=[];
  activeRadii.clear(); document.querySelectorAll('.radius-chip').forEach(b=>b.classList.remove('selected'));
  resetAllOtherModes('all');
  document.getElementById('searchInput').value=''; document.getElementById('results').style.display='none';
}
function fmt(d) { return d>=1000 ? (d/1000).toFixed(2)+'km' : Math.round(d)+'m'; }
function computeArea(pts) { const R=6378137; let a=0; for(let i=0;i<pts.length;i++){ let p1=pts[i], p2=pts[(i+1)%pts.length]; let x1=p1.lng*(Math.PI/180)*R*Math.cos(p1.lat*Math.PI/180), y1=p1.lat*(Math.PI/180)*R; let x2=p2.lng*(Math.PI/180)*R*Math.cos(p2.lat*Math.PI/180), y2=p2.lat*(Math.PI/180)*R; a += x1*y2 - x2*y1; } return Math.abs(a/2); }
async function doSearch() { const q=document.getElementById('searchInput').value; if(!q)return; const res=document.getElementById('results'); res.style.display='block'; res.innerHTML='<div class="result-item">..</div>'; try{ const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`); const d=await r.json(); res.innerHTML=''; if(!d.length){res.innerHTML='<div class="result-item">ì—†ìŒ</div>';return;} d.forEach(p=>{ const dv=document.createElement('div'); dv.className='result-item'; dv.innerText=p.display_name; dv.onclick=()=>{map.setView([p.lat,p.lon],16); res.style.display='none';}; res.appendChild(dv); }); }catch(e){res.innerHTML='ì—ëŸ¬';} }

// ë‚˜ì¹¨ë°˜
let isCompassOn = false;
function toggleCompass() {
  isCompassOn = !isCompassOn; const btn = document.getElementById('btnCompass');
  if(isCompassOn) { btn.classList.add('active'); if(window.DeviceOrientationEvent) window.addEventListener('deviceorientation', handleOri); else { alert("ì„¼ì„œ ë¯¸ì§€ì›"); isCompassOn=false; btn.classList.remove('active'); } }
  else { btn.classList.remove('active'); window.removeEventListener('deviceorientation', handleOri); document.querySelector('#btnCompass i').style.transform = 'rotate(0deg)'; }
}
function handleOri(e) { let h = e.webkitCompassHeading || (e.alpha ? 360 - e.alpha : 0); document.querySelector('#btnCompass i').style.transform = `rotate(${-h}deg)`; }

function resetAllOtherModes(cur) {
  if(cur!=='roadview') { isRoadViewMode=false; document.getElementById('btnRoadView').classList.remove('active'); if(roadViewMarker) map.removeLayer(roadViewMarker); }
  if(cur!=='route') { isRouteMode=false; document.getElementById('btnRoute').classList.remove('active'); rObjs.forEach(o=>map.removeLayer(o)); rObjs=[]; }
  if(cur!=='compass') { isCompassOn=false; document.getElementById('btnCompass').classList.remove('active'); }
  if(cur==='measure') { isRoadViewMode=false; isRouteMode=false; }
}
</script>
</body>

</html>





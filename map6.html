<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë§µ ë§ˆìŠ¤í„° v2.7 (ì¹´í†¡ ìŠ¤íƒ€ì¼ êµ¬í˜„)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
/* ë””ìì¸ í”„ë ˆì„ ìœ ì§€ */
html, body { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; background: #f4f4f4; }
#captureArea { position: relative; width: 100%; height: 100%; }
#map { width: 100%; height: 100%; z-index: 1; }

/* UI ìš”ì†Œ */
.top-bar { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; }
.search-container { display: flex; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
#searchInput { flex: 1; border: none; padding: 14px; font-size: 15px; border-radius: 12px; outline: none; }

.side-btns { position: absolute; top: 70px; right: 10px; z-index: 900; display: flex; flex-direction: column; gap: 10px; }
.fab { width: 46px; height: 46px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 18px; color: #333; cursor: pointer; border: none; }
.fab.active { background: #007bff; color: white; }

/* í•˜ë‹¨ ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼ íŒ¨ë„ */
.bottom-panel { position: absolute; bottom: 0; left: 0; right: 0; z-index: 1001; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.08); }
.panel-content { padding: 20px; }

.info-card { display: none; flex-direction: column; gap: 15px; }
.addr-box { border-left: 4px solid #fee500; padding-left: 12px; }
.addr-title { font-size: 13px; color: #888; margin-bottom: 4px; }
.addr-text { font-size: 16px; font-weight: bold; color: #111; line-height: 1.4; }

.action-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px; margin-top: 5px; }
.btn-kakao { background: #fee500; color: #181600; font-weight: bold; border-radius: 12px; padding: 15px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 15px; }
.btn-save { background: #f1f1f1; color: #333; font-weight: bold; border-radius: 12px; padding: 15px; border: none; cursor: pointer; font-size: 15px; }

.toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 25px; border-radius: 30px; z-index: 2000; font-size: 14px; display: none; }
</style>
</head>
<body>

<div id="captureArea">
    <div id="map"></div>
    <div id="toast" class="toast"></div>
</div>

<div class="top-bar">
    <div class="search-container">
        <input id="searchInput" type="text" placeholder="ì¥ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ì—­)" onkeydown="if(event.key==='Enter') doSearch()">
    </div>
</div>

<div class="side-btns">
    <div class="fab" id="gpsBtn" onclick="toggleGPS()"><i class="fas fa-crosshairs"></i></div>
    <div class="fab" onclick="window.location.reload()"><i class="fas fa-sync-alt"></i></div>
</div>

<div class="bottom-panel">
    <div class="panel-content">
        <div id="locPlaceholder" style="text-align:center; color:#999; padding: 10px 0;">ì§€ë„ì—ì„œ ê³µìœ í•  ìœ„ì¹˜ë¥¼ ì°ì–´ì£¼ì„¸ìš”.</div>
        <div id="locCard" class="info-card">
            <div class="addr-box">
                <div class="addr-title">ì„ íƒëœ ìœ„ì¹˜ ì£¼ì†Œ</div>
                <div id="addrText" class="addr-text">ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div class="action-grid">
                <button class="btn-kakao" onclick="shareLikeKakao()">
                    <i class="fas fa-comment"></i> ì¹´í†¡ ìœ„ì¹˜ ê³µìœ 
                </button>
                <button class="btn-save" onclick="saveAsImage()">
                    ì´ë¯¸ì§€ ì €ì¥
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/** [1] ì§€ë„ ê¸°ë³¸ ì„¤ì • **/
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.5665, 126.9780], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { crossOrigin: true }).addTo(map);

let myMarker = null;
let currentAddr = "";
let currentLatLng = null;

function setMarker(latlng) {
    if (myMarker) map.removeLayer(myMarker);
    myMarker = L.circleMarker(latlng, { radius: 10, color: 'white', weight: 3, fillColor: '#007bff', fillOpacity: 1 }).addTo(map);
}

async function updateInfo(latlng) {
    currentLatLng = latlng;
    document.getElementById('locPlaceholder').style.display = 'none';
    document.getElementById('locCard').style.display = 'flex';
    
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`, { headers: { 'Accept-Language': 'ko' } });
        const d = await res.json();
        currentAddr = d.display_name.split(',').reverse().join(' ').trim();
        document.getElementById('addrText').innerText = currentAddr;
    } catch(e) { currentAddr = "ì„ íƒëœ ìœ„ì¹˜"; }
}

/** [2] ì¹´ì¹´ì˜¤ API ì—†ì´ ì¹´í†¡ì²˜ëŸ¼ ê³µìœ í•˜ê¸° **/
async function shareLikeKakao() {
    if(!currentLatLng) return;

    // ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸°/ì§€ë„ë³´ê¸° ë§í¬ ìƒì„± (ìƒëŒ€ë°©ì´ í´ë¦­ ì‹œ ë°”ë¡œ ì•± ì—°ê²°)
    const kakaoMapUrl = `https://map.kakao.com/link/map/${encodeURIComponent(currentAddr)},${currentLatLng.lat},${currentLatLng.lng}`;
    const shareText = `[ìœ„ì¹˜ ê³µìœ ]\nğŸ“Œ ì£¼ì†Œ: ${currentAddr}\n\nì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ë©´ ì§€ë„ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.\n${kakaoMapUrl}`;

    if (navigator.share) {
        try {
            await navigator.share({
                title: 'ë‚´ ìœ„ì¹˜ ì •ë³´',
                text: shareText,
                // url: kakaoMapUrl // URL í•„ë“œë¥¼ ë„£ìœ¼ë©´ ì¹´í†¡ì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œê°€ ìƒì„±ë¨
            });
        } catch(e) { copyToClipboard(shareText); }
    } else {
        copyToClipboard(shareText);
    }
}

/** [3] ì´ë¯¸ì§€ ì €ì¥ (ì§€ë„+ì •ë³´ ê²°í•©) **/
function saveAsImage() {
    if(!currentLatLng) return;
    showToast("ìœ„ì¹˜ ì •ë³´ë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥ ì¤‘...");

    html2canvas(document.getElementById('captureArea'), { useCORS: true }).then(canvas => {
        const link = document.createElement('a');
        link.download = `ë‚´ìœ„ì¹˜_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL();
        link.click();
        showToast("ê°¤ëŸ¬ë¦¬ì— ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
    showToast("ì£¼ì†Œì™€ ì§€ë„ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¹´í†¡ì°½ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”!");
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.display = 'block';
    setTimeout(() => { t.style.display = 'none'; }, 2500);
}

/** [4] GPS ë° ê²€ìƒ‰ **/
function toggleGPS() {
    navigator.geolocation.getCurrentPosition((pos) => {
        const ll = L.latLng(pos.coords.latitude, pos.coords.longitude);
        setMarker(ll); map.panTo(ll); updateInfo(ll);
    }, () => alert("GPSë¥¼ ì¼¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."), { enableHighAccuracy: true });
}

async function doSearch() {
    const q = document.getElementById('searchInput').value;
    if(!q) return;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const d = await r.json();
    if(d.length > 0) {
        const ll = L.latLng(d[0].lat, d[0].lon);
        map.setView(ll, 16); setMarker(ll); updateInfo(ll);
    }
}

map.on('click', e => { setMarker(e.latlng); updateInfo(e.latlng); });
</script>
</body>
</html>

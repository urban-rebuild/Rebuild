<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë§µ ë§ˆìŠ¤í„°(ìœ„ì¹˜ì •ë³´ í†µí•©)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* 1. ê¸°ë³¸ ì„¤ì • */
html, body { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', -apple-system, sans-serif; overflow: hidden; background: #f5f5f5; }
#map { width: 100%; height: 100%; z-index: 1; }

/* 2. ìƒë‹¨ ë°” */
.top-bar { position: absolute; top: 12px; left: 12px; right: 12px; z-index: 1000; display: flex; gap: 8px; align-items: center; }
.search-box { flex: 1; display: flex; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden; }
#searchInput { flex: 1; border: none; padding: 12px 16px; font-size: 16px; outline: none; }
#searchBtn { background: #f8f9fa; color: #555; border: none; padding: 0 14px; cursor: pointer; border-left: 1px solid #eee; }
#layerBtn { background: white; color: #555; border: none; padding: 0 16px; cursor: pointer; border-left: 1px solid #eee; font-size: 18px; }

/* 3. ê³µí†µ ë²„íŠ¼ */
.btn-card { width: 44px; height: 44px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; font-size: 18px; color: #555; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); transition: all 0.1s ease-in-out; }
.btn-card:active { transform: scale(0.95); background: #f8f9fa; }
.btn-card.active { background: #3498db; color: white; border-color: #3498db; }

/* 4. í”Œë¡œíŒ… ê·¸ë£¹ */
.right-fab-group { position: absolute; top: 70px; right: 12px; z-index: 900; display: flex; flex-direction: column; gap: 10px; }
.nav-group { position: absolute; bottom: 100px; right: 12px; z-index: 900; display: flex; flex-direction: column; gap: 8px; }
.zoom-group { display: flex; flex-direction: column; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); overflow: hidden; }
.zoom-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: #555; }
.zoom-btn:first-child { border-bottom: 1px solid #eee; }

/* 5. ìœ„ì¹˜ ì •ë³´ ì¹´ë“œ (ì¶”ê°€ë¨) */
.location-card {
    position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 400px; background: #1a1c24; color: white;
    border-radius: 20px; padding: 20px; z-index: 1001;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: none;
}
.location-card h3 { margin: 0 0 10px 0; font-size: 18px; color: #fff; }
.addr-text { font-size: 15px; color: #d1d1d1; line-height: 1.4; margin-bottom: 8px; min-height: 40px; }
.coords-text { font-size: 13px; color: #888; margin-bottom: 15px; }
.loc-btn-row { display: flex; gap: 10px; }
.loc-btn {
    flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    border-radius: 25px; color: white; padding: 10px 0; font-size: 13px;
    display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer;
}
.loc-btn:active { background: rgba(255,255,255,0.2); }

/* 6. í•˜ë‹¨ ë… */
.bottom-dock {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    z-index: 1000; width: 92%; max-width: 500px;
    background: white; border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    padding: 6px; display: flex; flex-direction: column; gap: 5px;
}
.dock-tabs { display: flex; justify-content: space-between; background: #f8f9fa; border-radius: 10px; padding: 4px; }
.dock-tab { flex: 1; text-align: center; padding: 10px 0; font-size: 13px; font-weight: 600; color: #7f8c8d; border-radius: 8px; cursor: pointer; }
.dock-tab.active { background: white; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.action-row { display: flex; gap: 8px; margin-top: 5px; }
.action-btn { flex: 1; padding: 8px 0; border-radius: 6px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; }

/* ê¸°íƒ€ UI */
.layer-dropdown { position: absolute; top: 60px; right: 12px; z-index: 1100; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); overflow: hidden; display: none; width: 140px; }
.layer-item { padding: 12px; font-size: 14px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
.layer-item.active { background: #f0f8ff; color: #3498db; font-weight: bold; }
#results { position: absolute; top: 60px; left: 12px; right: 12px; max-width: 360px; z-index: 1100; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: none; }
.result-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
.dist-label { background: rgba(255,255,255,0.95); border: 1px solid #333; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; white-space: nowrap; pointer-events: none; }
.area-label { background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 20px; font-size: 14px; pointer-events: none; }
.popup-btn { display: block; width: 100%; padding: 10px 0; margin-top: 5px; background: #f1c40f; color: #333; border: none; border-radius: 4px; font-weight: bold; }

.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
.modal-box { background: white; width: 85%; max-width: 350px; border-radius: 12px; padding: 20px; }
</style>
</head>
<body>

<div class="top-bar">
    <div class="search-box">
        <input id="searchInput" type="text" placeholder="ì¥ì†Œ ê²€ìƒ‰" onkeydown="if(event.key==='Enter') doSearch()">
        <button id="searchBtn" onclick="doSearch()"><i class="fas fa-search"></i></button>
        <button id="layerBtn" onclick="toggleLayerMenu()"><i class="fas fa-layer-group"></i></button>
    </div>
</div>

<div id="results"></div>

<div class="layer-dropdown" id="layerMenu">
    <div class="layer-item active" onclick="setBaseLayer('vworld_base', this)">ë¸Œì´ì›”ë“œ (ì¼ë°˜)</div>
    <div class="layer-item" onclick="setBaseLayer('vworld_sat', this)">ë¸Œì´ì›”ë“œ (ìœ„ì„±)</div>
    <div class="layer-item" onclick="setBaseLayer('google', this)">êµ¬ê¸€ ì§€ë„</div>
</div>

<div class="right-fab-group">
    <div class="btn-card" onclick="toggleHelp()" style="color:#3498db; border: 1px solid #3498db;"><i class="fas fa-question"></i></div>
    <div class="btn-card" id="btnRoadView" onclick="toggleRoadViewMode()"><i class="fas fa-street-view"></i></div>
    <div class="btn-card" id="btnRoute" onclick="toggleRouteMode()"><i class="fas fa-route"></i></div>
</div>

<div class="nav-group">
    <div class="btn-card" id="btnCompass" onclick="toggleCompass()"><i class="far fa-compass"></i></div>
    <div class="btn-card" id="btnGPS" onclick="toggleLocationTracking()"><i class="fas fa-crosshairs"></i></div>
    <div class="zoom-group">
        <div class="zoom-btn" onclick="map.zoomIn()"><i class="fas fa-plus"></i></div>
        <div class="zoom-btn" onclick="map.zoomOut()"><i class="fas fa-minus"></i></div>
    </div>
</div>

<div id="locationCard" class="location-card">
    <h3>ë‚˜ì˜ í˜„ì¬ ìœ„ì¹˜</h3>
    <div id="addrDisplay" class="addr-text">ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="coordsDisplay" class="coords-text">Lat: 0.000000 Â· Lng: 0.000000</div>
    <div class="loc-btn-row">
        <div class="loc-btn" onclick="copyLocation()"><i class="far fa-copy"></i> ë³µì‚¬</div>
        <div class="loc-btn" onclick="shareLocation()"><i class="fas fa-share-alt"></i> ê³µìœ </div>
        <div class="loc-btn" onclick="saveLocation()"><i class="far fa-bookmark"></i> ì €ì¥</div>
    </div>
</div>

<div id="map"></div>

<div class="bottom-dock">
    <div class="dock-tabs">
        <div class="dock-tab active" onclick="setMode('line')" id="btnLine">ğŸ“ ê±°ë¦¬</div>
        <div class="dock-tab" onclick="setMode('polygon')" id="btnPoly">ğŸ“ ë©´ì </div>
        <div class="dock-tab" onclick="setMode('circle')" id="btnCircle">â­• ë°˜ê²½</div>
    </div>
    <div class="dock-content">
        <div id="infoText" style="font-size:13px; color:#555; padding:5px 0; text-align:center;">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì¸¡ì •ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
        <div class="action-row">
            <button id="undoBtn" class="action-btn" onclick="undoLastPoint()" style="display:none; background:#95a5a6; color:white;">ì‹¤í–‰ ì·¨ì†Œ</button>
            <button class="action-btn" onclick="resetAll()" style="background:#e74c3c; color:white;">ì´ˆê¸°í™”</button>
        </div>
    </div>
</div>

<div id="helpModal" class="modal-overlay" onclick="if(event.target===this) toggleHelp()">
    <div class="modal-box">
        <div style="font-size:18px; font-weight:bold; margin-bottom:15px; border-bottom:2px solid #3498db; padding-bottom:10px;">ğŸ“– ì•± ê°€ì´ë“œ</div>
        <div style="font-size:13px; line-height:1.8;">
            - <b>ìœ„ì¹˜ ì •ë³´:</b> ì§€ë„ í´ë¦­, ê²€ìƒ‰, GPS ì´ë™ ì‹œ í•˜ë‹¨ì— ì£¼ì†Œê°€ í‘œì‹œë©ë‹ˆë‹¤.<br>
            - <b>ê±°ë¦¬ ì¸¡ì •:</b> ì„ ì„ ê·¸ë ¤ ì‹¤ì œ ê±°ë¦¬ë¥¼ ì½ë‹ˆë‹¤.<br>
            - <b>ë©´ì  ì¸¡ì •:</b> ë‹¤ê°í˜•ì„ ê·¸ë ¤ ì œê³±ë¯¸í„°ì™€ í‰ìˆ˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.<br>
            - <b>ë¡œë“œë·°:</b> ëª¨ë“œ í™œì„±í™” í›„ ë„ë¡œë¥¼ í´ë¦­í•˜ë©´ ì¹´ì¹´ì˜¤ ë¡œë“œë·°ê°€ ì—°ê²°ë©ë‹ˆë‹¤.
        </div>
        <button class="action-btn" style="width:100%; margin-top:15px; background:#3498db; color:white;" onclick="toggleHelp()">ë‹«ê¸°</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/** 1. ì§€ë„ ì´ˆê¸°í™” ë° ë ˆì´ì–´ ì„¤ì • **/
const map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 16);
const baseLayers = {
    vworld_base: L.tileLayer('https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png', { maxZoom: 19 }),
    vworld_sat: L.layerGroup([
        L.tileLayer('https://xdworld.vworld.kr/2d/Satellite/service/{z}/{x}/{y}.jpeg', { maxZoom: 19 }),
        L.tileLayer('https://xdworld.vworld.kr/2d/Hybrid/service/{z}/{x}/{y}.png', { maxZoom: 19 })
    ]),
    google: L.tileLayer('https://mt0.google.com/vt/lyrs=m&hl=ko&x={x}&y={y}&z={z}', { maxZoom: 20 })
};
baseLayers.vworld_base.addTo(map);

function setBaseLayer(type, el) {
    Object.values(baseLayers).forEach(l => map.removeLayer(l));
    baseLayers[type].addTo(map);
    document.querySelectorAll('.layer-item').forEach(o => o.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('layerMenu').style.display = 'none';
}

/** 2. ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸ ë¡œì§ (í•µì‹¬ ìš”êµ¬ì‚¬í•­) **/
const locCard = document.getElementById('locationCard');
const addrDisplay = document.getElementById('addrDisplay');
const coordsDisplay = document.getElementById('coordsDisplay');

// ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸° (Reverse Geocoding)
async function updateLocationInfo(latlng) {
    locCard.style.display = 'block';
    const lat = latlng.lat.toFixed(6);
    const lng = latlng.lng.toFixed(6);
    coordsDisplay.innerText = `Lat: ${lat} Â· Lng: ${lng}`;
    addrDisplay.innerText = "ì£¼ì†Œë¥¼ ì°¾ëŠ” ì¤‘...";

    try {
        // OSM Nominatim API (ë¬´ë£Œ) ì‚¬ìš©
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`, {
            headers: { 'Accept-Language': 'ko' }
        });
        const data = await response.json();
        addrDisplay.innerText = data.display_name || "ì£¼ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    } catch (e) {
        addrDisplay.innerText = "ì£¼ì†Œ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    }
}

// ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ í†µí•©
map.on('click', e => {
    if(isRoadViewMode) { handleRoadView(e); return; }
    if(isRouteMode) { handleRouteClick(e); return; }
    
    // ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸ (ì§€ì  ì„ íƒ)
    updateLocationInfo(e.latlng);

    // ì¸¡ì • ë¡œì§
    if(mode==='line' || mode==='polygon') { points.push(e.latlng); redraw(); }
});

// ì§€ë„ ì´ë™ ì¢…ë£Œ ì‹œ ì¤‘ì‹¬ì  ì£¼ì†Œ ì—…ë°ì´íŠ¸ (ì§€ë„ ì´ë™ ë°©ì‹)
map.on('moveend', () => {
    if(!points.length && !isRoadViewMode && !isRouteMode) {
        updateLocationInfo(map.getCenter());
    }
});

/** 3. ìœ„ì¹˜ ì¹´ë“œ ì•¡ì…˜ ë²„íŠ¼ ê¸°ëŠ¥ **/
function copyLocation() {
    const text = `${addrDisplay.innerText}\nì¢Œí‘œ: ${coordsDisplay.innerText}`;
    navigator.clipboard.writeText(text).then(() => alert("ì£¼ì†Œì™€ ì¢Œí‘œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
}

function shareLocation() {
    if (navigator.share) {
        navigator.share({
            title: 'ë‚´ ìœ„ì¹˜ ì •ë³´',
            text: addrDisplay.innerText,
            url: `https://www.google.com/maps?q=${map.getCenter().lat},${map.getCenter().lng}`
        });
    } else {
        alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
}

function saveLocation() {
    const saved = { addr: addrDisplay.innerText, latlng: map.getCenter() };
    localStorage.setItem('saved_loc', JSON.stringify(saved));
    alert("í˜„ì¬ ìœ„ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/** 4. ê¸°ì¡´ ê¸°ëŠ¥ë“¤ (ê±°ë¦¬/ë©´ì /GPS/ë¡œë“œë·° ë“± - ë¡œì§ ìœ ì§€) **/
let mode = 'line'; let points = []; let mapObjs = [];
let watchId = null; let myMarker = null;

function toggleLocationTracking() {
    const btn = document.getElementById('btnGPS');
    if(watchId) { navigator.geolocation.clearWatch(watchId); watchId=null; btn.classList.remove('active'); }
    else {
        btn.classList.add('active');
        watchId = navigator.geolocation.watchPosition(p=>{
            const latlng = L.latLng(p.coords.latitude, p.coords.longitude);
            map.setView(latlng, 17);
            if(!myMarker) myMarker = L.circleMarker(latlng,{radius:8,color:'white',fillColor:'#007bff',fillOpacity:1}).addTo(map);
            else myMarker.setLatLng(latlng);
            updateLocationInfo(latlng); // GPS ì´ë™ ì‹œ ì£¼ì†Œ ì—…ë°ì´íŠ¸
        }, null, {enableHighAccuracy:true});
    }
}

async function doSearch() {
    const q = document.getElementById('searchInput').value;
    if(!q) return;
    const res = document.getElementById('results');
    res.style.display = 'block';
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`);
        const data = await r.json();
        res.innerHTML = '';
        data.forEach(p => {
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerText = p.display_name;
            item.onclick = () => {
                const latlng = L.latLng(p.lat, p.lon);
                map.setView(latlng, 16);
                updateLocationInfo(latlng); // ê²€ìƒ‰ ê²°ê³¼ ì´ë™ ì‹œ ì£¼ì†Œ ì—…ë°ì´íŠ¸
                res.style.display = 'none';
            };
            res.appendChild(item);
        });
    } catch(e) { res.innerText = "ê²€ìƒ‰ ì—ëŸ¬"; }
}

function setMode(newMode) {
    mode = newMode;
    document.querySelectorAll('.dock-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('btn' + newMode.charAt(0).toUpperCase() + newMode.slice(1,4)).classList.add('active');
    resetCurrentDrawing();
}

function redraw() {
    mapObjs.forEach(o=>map.removeLayer(o)); mapObjs=[];
    if(!points.length) { document.getElementById('undoBtn').style.display='none'; return; }
    document.getElementById('undoBtn').style.display='inline-block';
    
    points.forEach(p=> { mapObjs.push(L.circleMarker(p,{radius:4,color:'red'}).addTo(map)); });

    if(mode==='line' && points.length>1) {
        mapObjs.push(L.polyline(points,{color:'blue'}).addTo(map));
        const total = points.reduce((acc,cur,idx,arr)=> idx>0?acc+map.distance(arr[idx-1],cur):0, 0);
        mapObjs.push(L.marker(points[points.length-1], {icon: L.divIcon({className:'dist-label', html:fmt(total)})}).addTo(map));
    }
    if(mode==='polygon' && points.length>=3) {
        mapObjs.push(L.polygon(points,{color:'#f39c12'}).addTo(map));
        const area = computeArea(points);
        const center = L.polygon(points).getBounds().getCenter();
        const html = `${Math.round(area).toLocaleString()}ã¡<br>(${(area/3.3058).toFixed(1)}í‰)`;
        mapObjs.push(L.marker(center, {icon: L.divIcon({className:'area-label', html:html})}).addTo(map));
    }
}

// í—¬í¼ í•¨ìˆ˜ë“¤
function toggleLayerMenu() { const m = document.getElementById('layerMenu'); m.style.display = m.style.display==='block'?'none':'block'; }
function toggleHelp() { const m = document.getElementById('helpModal'); m.style.display = m.style.display==='flex'?'none':'flex'; }
function resetCurrentDrawing() { points=[]; mapObjs.forEach(o=>map.removeLayer(o)); mapObjs=[]; redraw(); }
function resetAll() { resetCurrentDrawing(); document.getElementById('locationCard').style.display='none'; }
function undoLastPoint() { points.pop(); redraw(); }
function fmt(d) { return d>=1000 ? (d/1000).toFixed(2)+'km' : Math.round(d)+'m'; }
function computeArea(pts) { 
    const R=6378137; let a=0; 
    for(let i=0;i<pts.length;i++){ 
        let p1=pts[i], p2=pts[(i+1)%pts.length]; 
        let x1=p1.lng*(Math.PI/180)*R*Math.cos(p1.lat*Math.PI/180), y1=p1.lat*(Math.PI/180)*R; 
        let x2=p2.lng*(Math.PI/180)*R*Math.cos(p2.lat*Math.PI/180), y2=p2.lat*(Math.PI/180)*R; 
        a += x1*y2 - x2*y1; 
    } return Math.abs(a/2); 
}

// ë¡œë“œë·° ë° ê¸°íƒ€ ëª¨ë“œ ì œì–´
let isRoadViewMode = false;
function toggleRoadViewMode() {
    isRoadViewMode = !isRoadViewMode;
    const btn = document.getElementById('btnRoadView');
    btn.classList.toggle('active', isRoadViewMode);
    document.getElementById('infoText').innerText = isRoadViewMode ? "ë„ë¡œë¥¼ í´ë¦­í•˜ë©´ ë¡œë“œë·°ê°€ ì—´ë¦½ë‹ˆë‹¤." : "ì¸¡ì • ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.";
}
function handleRoadView(e) {
    const url = `https://map.kakao.com/link/roadview/${e.latlng.lat},${e.latlng.lng}`;
    window.open(url, '_blank');
}

let isRouteMode = false;
function toggleRouteMode() {
    isRouteMode = !isRouteMode;
    document.getElementById('btnRoute').classList.toggle('active', isRouteMode);
}

// ë‚˜ì¹¨ë°˜ ê¸°ëŠ¥
let isCompassOn = false;
function toggleCompass() {
    isCompassOn = !isCompassOn;
    const btn = document.getElementById('btnCompass');
    if(isCompassOn) {
        btn.classList.add('active');
        window.addEventListener('deviceorientation', handleOri, true);
    } else {
        btn.classList.remove('active');
        window.removeEventListener('deviceorientation', handleOri);
        document.querySelector('#btnCompass i').style.transform = 'rotate(0deg)';
    }
}
function handleOri(e) {
    let h = e.webkitCompassHeading || (e.alpha ? 360 - e.alpha : 0);
    document.querySelector('#btnCompass i').style.transform = `rotate(${-h}deg)`;
}
</script>
</body>
</html>
